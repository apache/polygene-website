<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Assemble an Application</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="" /><link rel="up" href="tutorials.html" title="Tutorials" /><link rel="prev" href="howto-depend-on-polygene.html" title="Depend on Polygene™" /><link rel="next" href="tut-composites.html" title="Transient Composites Tutorial" />


    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Starter Template for Bootstrap</title>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/polygene-ng.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

<!-- favicon -->

<link rel="shortcut icon" href="http://polygene.apache.org/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="icon" href="http://polygene.apache.org/favicon.ico" type="image/x-icon" />

<!-- style -->

<link href="css/shCore.css" rel="stylesheet" type="text/css" />
<link href="css/shCoreEclipse.css" rel="stylesheet" type="text/css" />
<link href="css/shThemeEclipse.css" rel="stylesheet" type="text/css" />
<!--<link href="css/polygene.css" rel="stylesheet" type="text/css" />-->

<!-- Syntax Highlighter -->

<script type="text/javascript" src="js/shCore.js"></script>
<script type="text/javascript" src="js/shBrushJava.js"></script>
<script type="text/javascript" src="js/shBrushScala.js"></script>
<script type="text/javascript" src="js/shBrushJScript.js"></script>
<script type="text/javascript" src="js/shBrushBash.js"></script>
<script type="text/javascript" src="js/shBrushPlain.js"></script>
<script type="text/javascript" src="js/shBrushXml.js"></script>
<script type="text/javascript" src="js/shBrushGroovy.js"></script>
<script type="text/javascript" src="js/shBrushPython.js"></script>
<script type="text/javascript" src="js/shBrushRuby.js"></script>
<script type="text/javascript" src="js/shBrushCSharp.js"></script>

<script type="text/javascript">
  SyntaxHighlighter.defaults['tab-size'] = 4;
  SyntaxHighlighter.defaults['gutter'] = false;
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all()
</script>

<!-- JQuery -->

<script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>

<!-- Image Scaler -->

<script type="text/javascript" src="js/imagescaler.js"></script>

<!-- Table Styler -->

<script type="text/javascript" src="js/tablestyler.js"></script>

<!-- Apache Polygene WebSite Progressive Enhancement -->

<link href="css/progressive-enhancement.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/jquery.scrollTo-1.4.2.js"></script>
<script type="text/javascript" src="js/progressive-enhancement.js"></script>

<!-- Analytics -->
 <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-62007352-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
 </script>

  </head><body><div xmlns="" xmlns:exsl="http://exslt.org/common" class="logo"><a href="index.html"><img src="images/logo-standard.png" /></a></div><nav xmlns="" xmlns:exsl="http://exslt.org/common" class="navbar navbar-inverse navbar-fixed-top"><div class="container"><div class="navbar-header"><a class="navbar-brand" href="#">Apache<br />Polygene
          </a></div><div id="navbar" class="collapse navbar-collapse"><span class="nav navbar-nav"><div xmlns="http://www.w3.org/1999/xhtml" class="toc"><dl class="toc"><dt><span class="section"><a href="index.html#home">Polygene™</a></span></dt><dt><span class="section"><a href="intro.html">Introduction</a></span></dt><dt><span class="section"><span xmlns="" href="tutorials.html">Tutorials</span></span></dt><dt><span class="section"><a href="javadocs.html">Javadoc</a></span></dt><dt><span class="section"><a href="samples.html">Samples</a></span></dt><dt><span class="section"><a href="core.html">Core</a></span></dt><dt><span class="section"><a href="libraries.html">Libraries</a></span></dt><dt><span class="section"><a href="extensions.html">Extensions</a></span></dt><dt><span class="section"><a href="tools.html">Tools</a></span></dt><dt><span class="section"><a href="glossary.html">Glossary </a></span></dt></dl></div></span></div></div></nav><div xmlns="" xmlns:exsl="http://exslt.org/common" class="sidenav"><div xmlns="http://www.w3.org/1999/xhtml" class="toc"><dl class="toc"><dt><span class="section"><a href="tutorials.html#_overview">Overview</a></span></dt><dt><span class="section"><a href="two-minutes-intro.html">Polygene™ in 2 minutes</a></span></dt><dt><span class="section"><a href="ten-minutes-intro.html">Polygene™ in 10 minutes</a></span></dt><dt><span class="section"><a href="thirty-minutes-intro.html">Polygene™ in 30 minutes</a></span></dt><dt><span class="section"><a href="howto-depend-on-polygene.html">Depend on Polygene™</a></span></dt><dt><span class="section"><span xmlns="" href="howto-assemble-application.html">Assemble an Application</span></span></dt><dt><span class="section"><a href="tut-composites.html">Transient Composites Tutorial</a></span></dt><dt><span class="section"><a href="tut-services.html">Services Composites Tutorial</a></span></dt><dt><span class="section"><a href="howto-contextual-fragments.html">Use contextual fragments</a></span></dt><dt><span class="section"><a href="howto-leverage-properties.html">Leverage Properties</a></span></dt><dt><span class="section"><a href="howto-create-constraint.html">Create a Constraint</a></span></dt><dt><span class="section"><a href="howto-create-concern.html">Create a Concern</a></span></dt><dt><span class="section"><a href="howto-create-sideeffect.html">Create a SideEffect</a></span></dt><dt><span class="section"><a href="howto-create-entity.html">Create an Entity</a></span></dt><dt><span class="section"><a href="howto-configure-service.html">Configure a Service</a></span></dt><dt><span class="section"><a href="howto-invocation-annotation.html">Use @Invocation</a></span></dt><dt><span class="section"><a href="build-system.html">Polygene™ Build System</a></span></dt><dt><span class="section"><a href="community-docs.html">Polygene™ Documentation</a></span></dt><dt><span class="section"><a href="releasing-apache.html">Releasing Polygene™</a></span></dt></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="howto-assemble-application"></a>Assemble an Application</h3></div></div></div><p>We receive a lot of questions about how applications should be assembled, and since we don’t have any XML to "fill in"
and everything is to be done programmatically, it escalates the need to provide more hands-on explanation of how this is
done.</p><p>If you want to reproduce what’s explained in this tutorial, remember to depend on the Core Bootstrap artifact:</p><div class="table"><a id="idm928"></a><p class="title"><strong>Table 4. Artifact</strong></p><div class="table-contents"><table summary="Artifact" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th align="left" valign="top">Group ID</th><th align="left" valign="top">Artifact ID</th><th align="left" valign="top">Version</th></tr></thead><tbody><tr><td align="left" valign="top"><p>org.apache.polygene.core</p></td><td align="left" valign="top"><p>org.apache.polygene.core.bootstrap</p></td><td align="left" valign="top"><p>0</p></td></tr></tbody></table></div></div><br class="table-break" /><p>At runtime you will need the Core Runtime artifact too. See the <a class="xref" href="howto-depend-on-polygene.html" title="Depend on Polygene™">Depend on Polygene™</a> tutorial for details.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_basics"></a>Basics</h4></div></div></div><p>First let’s recap the structural requirements of Polygene;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
There is one and only one Application instance per Polygene™ Runtime.
</li><li class="listitem">
Every Application must contain one or more Layers.
</li><li class="listitem">
All Composites must be declared in one or more Modules.
</li><li class="listitem">
Each Module belong to a Layer.
</li><li class="listitem">
Layers are ordered in hierarchies, from simple to complex.
</li><li class="listitem">
Access to Composites are limited by visibility rules.
</li></ul></div><p>Ok, that was quite a handful. Let’s look at them one by one.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_application"></a>Application</h4></div></div></div><p>The first one means that for each Polygene™ Runtime you start, there will be exactly one application. As far as we know, Polygene
is fully isolated, meaning there are no static members being populated and such.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_layers"></a>Layers</h4></div></div></div><p>Layers are the super-structures of an application. We have been talking about them for decades, drawn them on paper and
whiteboards (or even black boards for those old enough), and sometimes organized the codebases along such boundaries.
But, there has been little effort to enforce the Layer mechanism in code, although it is an extremely powerful
construct. First of all it implies directional dependency and a high degree of order, spagetti code is reduced if
successfully implemented. For Polygene, it means that we can restrict access to Composite and Object declarations, so that
higher layers can not reach them incidentally. You can enforce architecture to a high degree. You can require all
creation of composites to go through an exposed Factory, which doesn’t require the Composite to be public. And so on.
Layers have hierarchy, i.e. one layer is top of one or more layers, and is below one or more layers, except for the
layers at the top and bottom. You could have disjoint layers, which can’t access each other, meaning a couple of layers
that are both the top and bottom.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_modules"></a>Modules</h4></div></div></div><p>The Module concept has also been around forever. And in Polygene™ we also makes the Modules explicit. Each Module belong to a
Layer, and for each Module you declare the Composite and Object types for that Module, together with a Visibility rule,
one of; application, layer, module.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_visibility"></a>Visibility</h4></div></div></div><p>The Visibility rules are perhaps the most powerful aspect of the above. Visibility is a mechanism that kicks in whenever
a Composite type need to be looked up. It defines both the scoping rules of the client as well as the provider. A lookup
is either a direct reference, such as</p><pre class="programlisting brush: java">UnitOfWork unitOfWork = module.currentUnitOfWork();
PersonEntity person = unitOfWork.newEntity( PersonEntity.class );
</pre><p>or an indirect lookup, such as</p><pre class="programlisting brush: java">UnitOfWork unitOfWork = module.currentUnitOfWork();
Person person = unitOfWork.newEntity( Person.class );
</pre><p>where it will first map the Person to a reachable PersonEntity.
The algorithm is as follows;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Look in the callers Module, if there is one and only one Composite type matching, use it. If there are two or more
      Composite types matching, then throw an ambiguity exception. If there are zero, proceed to the next step.
</li><li class="listitem">
Look in all Modules in the callers Layer. If there is one and only one Composite type that matches and is either
      Visibility.layer, then use it.  If there are two or more Composite types matching, then throw an ambiguity
      exception. If there are zero, proceed to the next step.
</li><li class="listitem">
Look in all Layers that caller’s Layer uses. If there is one and only one Composite type that matches and is
      either Visibility.application, then use it.  If there are two or more Composite types matching, then throw an
      ambiguity exception. If there are zero, proceed to the next step.
</li><li class="listitem">
Throw a CompositeNotFoundException.
</li></ul></div><p>The underlying principle comes down to Rickard’s "Speaker Analogy", you can hear him (and not the other speakers at the
conference) because you are in the same room. I.e. if something is really close by, it is very likely that this is what
we want to use, and then the search expands outwards.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_combining_the_above"></a>Combining The Above</h4></div></div></div><p>Ok, that was a whole lot of theory and probably take you more than one read-through to fully get into your veins (slow
acting addiction).
How to structure your code is beyond the scope of this section. If you are an experienced designer, you will have done
that before, and you may have started out with good intentions at times only to find yourself in a spaghetti swamp
later, or perhaps in the also famous "Clear as Clay" or "Ball (bowl?) of Mud". Either way, you need to draw on your
experience and come up with good structure that Polygene™ lets you enforce.</p><p>So, for the sake of education, we are going to look at an application that consists of many layers, each with a few
modules. See picture below.</p><p>Image of Example of Layers</p><p>Figure 1. Example of Layers</p><p>So, lets see how we code up this bit in the actual code first.</p><pre class="programlisting brush: java">public class Main
{
    private static Energy4Java polygene;
    private static Application application;

    public static void main( String[] args )
            throws Exception
    {
        // Bootstrap Polygene Runtime
        // Create a Polygene Runtime
        polygene = new Energy4Java();

        // Instantiate the Application Model.
        application = polygene.newApplication( new ApplicationAssembler()
        {
            public ApplicationAssembly assemble(
                    ApplicationAssemblyFactory factory )
                    throws AssemblyException
            {
                ApplicationAssembly assembly =
                        factory.newApplicationAssembly();
                LayerAssembly runtime = createRuntimeLayer( assembly );
                LayerAssembly designer = createDesignerLayer( assembly );
                LayerAssembly domain = createDomainLayer( assembly );
                LayerAssembly messaging= createMessagingLayer( assembly );
                LayerAssembly persistence = createPersistenceLayer( assembly );

                // declare structure between layers
                domain.uses( messaging );
                domain.uses( persistence );
                designer.uses( persistence );
                designer.uses( domain );
                runtime.uses( domain );

                return assembly;
            }
        } );

        // We need to handle shutdown.
        installShutdownHook();

        // Activate the Application Runtime.
        application.activate();
    }

      [...snip...]

}

</pre><p>The above is the basic setup on how to structure a real-world applicaton, unless you intend to mess with the
implementations of various Polygene™ systems (yes there are hooks for that too), but that is definitely beyond the scope of
this tutorial.</p><p>Now, the createXyzLayer() methods were excluded to keep the sample crisp and easy to follow. Let’s take a look at what
it could be to create the Domain Layer.</p><pre class="programlisting brush: java">private static LayerAssembly createDomainLayer( ApplicationAssembly app )
{
    LayerAssembly layer = app.layer("domain-layer");
    createAccountModule( layer );
    createInventoryModule( layer );
    createReceivablesModule( layer );
    createPayablesModule( layer );
    return layer;
}

</pre><p>We just call the layerAssembly() method, which will return either an existing Layer with that name or create a new one
if one doesn’t already exist, and then delegate to methods for creating the ModuleAssembly instances. In those method
we need to declare which Composites, Entities, Services and Objects that is in each Module.</p><pre class="programlisting brush: java">private static void createAccountModule( LayerAssembly layer )
{
    ModuleAssembly module = layer.module("account-module");

    module.entities(AccountEntity.class, EntryEntity.class);

    module.addServices(
            AccountRepositoryService.class,
            AccountFactoryService.class,
            EntryFactoryService.class,
            EntryRepositoryService.class
    ).visibleIn( Visibility.layer );
}

</pre><p>We also need to handle the shutdown case, so in the main() method we have a installShutdownHook() method call. It is
actually very, very simple;</p><pre class="programlisting brush: java">private static void installShutdownHook()
{
    Runtime.getRuntime().addShutdownHook( new Thread( new Runnable()
    {
        public void run()
        {
            if( application != null )
            {
                try
                {
                    application.passivate();
                }
                catch( Exception e )
                {
                    e.printStackTrace();
                }
            }
        }
    }) );
}
</pre><p>This concludes this tutorial. We have looked how to get the initial Polygene™ runtime going, how to declare the assembly
for application model creation and finally the activation of the model itself.</p></div></div><footer xmlns="" xmlns:exsl="http://exslt.org/common" class="footer"><div class="container"><p class="text-muted">Copyright © 2017 The Apache Software Foundation, Licensed under the <a href="http://www.apache.org/licenses/" target="_blank">Apache License, Version 2.0</a>.
          Apache Polygene, Polygene, Apache, the Apache feather logo, and the Apache Polygene project logo are
          trademarks of The Apache Software Foundation.
          All other marks mentioned may be trademarks or registered trademarks of their respective owners.
        </p></div></footer><script xmlns="" xmlns:exsl="http://exslt.org/common" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script><script xmlns="" xmlns:exsl="http://exslt.org/common">window.jQuery || document.write('&lt;script src="js/jquery-1.6.4.min.js"&gt;&lt;/script&gt;')</script><script xmlns="" xmlns:exsl="http://exslt.org/common" src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script><script xmlns="" xmlns:exsl="http://exslt.org/common" src="bootstrap-3.3.7/js/bootstrap.min.js"></script><script xmlns="" xmlns:exsl="http://exslt.org/common" src="js/ie10-viewport-bug-workaround.js"></script></body></html>